# Sample workflow for building and deploying a Hugo site to GitHub Pages
name: Deploy Hugo site to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["master"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    
  # Runs automatically at 6 a.m. UTC every day
  schedule:
    - cron: '0 6 * * *'

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

# Default to bash
defaults:
  run:
    shell: bash

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.147.8
    steps:
      - name: Install Hugo CLI
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb
      - name: Install Dart Sass
        run: sudo snap install dart-sass
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5
      - name: Install Node.js dependencies
        run: "[[ -f package-lock.json || -f npm-shrinkwrap.json ]] && npm ci || true"
      - name: Build with Hugo
        env:
          # For maximum backward compatibility with Hugo modules
          HUGO_ENVIRONMENT: production
          HUGO_ENV: production
        run: |
          hugo \
            --minify \
            --baseURL "${{ steps.pages.outputs.base_url }}/"
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: https://jaxplays.org
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Send Pushover Success Notification
        if: success()  # This ensures the step only runs if the previous steps were successful
        uses: umahmood/pushover-actions@main
        env:
          PUSHOVER_TOKEN: ${{ secrets.PUSHOVER_TOKEN }}
          PUSHOVER_USER: ${{ secrets.PUSHOVER_USER }}
        with:
          status: ${{ job.status }}
          title: 'Success! Deployment Complete'
          message: 'Your update to jaxplays.org has been successfully deployed to GitHub Pages.'

      - name: Send Pushover Failure Notification
        if: failure()  # This ensures the step only runs if the previous steps failed
        uses: umahmood/pushover-actions@main
        env:
          PUSHOVER_TOKEN: ${{ secrets.PUSHOVER_TOKEN }}
          PUSHOVER_USER: ${{ secrets.PUSHOVER_USER }}
        with:
          status: ${{ job.status }}
          title: 'Failed. Deployment Incomplete'
          message: 'Your update to jaxplays.org has failed to deploy to GitHub Pages. Check the logs for details.'

  mailchimp_draft:
    name: Create Mailchimp draft campaigns
    needs: deploy
    runs-on: ubuntu-latest
    # Only run this job on push events, not on schedule or manual dispatch
    if: github.event_name == 'push'
    env:
      MAILCHIMP_API_KEY: ${{ secrets.MAILCHIMP_API_KEY }}
      MAILCHIMP_SERVER_PREFIX: ${{ secrets.MAILCHIMP_SERVER_PREFIX }}
      MAILCHIMP_LIST_ID: ${{ secrets.MAILCHIMP_LIST_ID }}
      MAILCHIMP_FROM_EMAIL: ${{ secrets.MAILCHIMP_FROM_EMAIL }}
      MAILCHIMP_FROM_NAME: ${{ secrets.MAILCHIMP_FROM_NAME }}
      MAILCHIMP_REPLY_TO: ${{ secrets.MAILCHIMP_REPLY_TO }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find newly added reviews and news
        id: find_posts
        run: |
          echo "Checking for newly added review and news content files between:"
          echo "  Before: ${{ github.event.before }}"
          echo "  After:  ${{ github.sha }}"

          NEW_FILES=$(git diff --name-status "${{ github.event.before }}" "${{ github.sha }}" \
            | awk '$1=="A"{print $2}' \
            | grep -E '^content/(reviews|news)/' || true)

          if [ -z "$NEW_FILES" ]; then
            echo "No new review or news files added. Skipping Mailchimp."
            echo "has_new=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Newly added content files:"
          printf "%s\n" "$NEW_FILES"
          printf "%s\n" "$NEW_FILES" > new_files.txt

          echo "has_new=true" >> "$GITHUB_OUTPUT"

      - name: Create Mailchimp draft campaigns
        if: steps.find_posts.outputs.has_new == 'true'
        run: |
          while IFS= read -r FILE; do
            # Skip empty lines
            if [ -z "$FILE" ]; then
              continue
            fi

            echo "Processing file: $FILE"

            # Decide template and label based on section
            if [[ "$FILE" == content/reviews/* ]]; then
              TEMPLATE_ID=10623509
              KIND="Review"
            elif [[ "$FILE" == content/news/* ]]; then
              TEMPLATE_ID=10623325
              KIND="News"
            else
              echo "Skipping $FILE (not in reviews or news)"
              continue
            fi

            BASENAME=$(basename "$FILE")
            SUBJECT="$KIND published on JaxPlays"
            TITLE="Draft for $BASENAME"

            echo "Creating Mailchimp draft campaign with template_id=$TEMPLATE_ID"
            echo "  Subject: $SUBJECT"
            echo "  Title:   $TITLE"

            curl -sS -X POST "https://${MAILCHIMP_SERVER_PREFIX}.api.mailchimp.com/3.0/campaigns" \
              -u "anystring:${MAILCHIMP_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{
                "type": "regular",
                "recipients": {
                  "list_id": "'"${MAILCHIMP_LIST_ID}"'"
                },
                "settings": {
                  "subject_line": "'"${SUBJECT}"'",
                  "title": "'"${TITLE}"'",
                  "from_name": "'"${MAILCHIMP_FROM_NAME}"'",
                  "reply_to": "'"${MAILCHIMP_REPLY_TO}"'",
                  "template_id": '"${TEMPLATE_ID}"'
                },
                "status": "save"
              }'

            echo
          done < new_files.txt
