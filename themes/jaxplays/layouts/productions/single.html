{{ define "header" }}{{ partial "production-header.html" . }}{{ end }}
{{ define "main" }}
<div class="flex-l mt0 mw8 center">
  <article class="center cf pv4 ph3 ph4-ns mw8">
    <header>
      <h1 class="f3 f2-l f1-m mb0">
        {{ .Title }}
      </h1>
      <h2 class="fw4 f3-ns f5 ttu">
        {{ with .Params.date }}{{ dateFormat "2006" . }}{{ end }}
        {{ if and .Params.date .Params.theatre }}&#8226;{{ end }}
        {{ .Params.theatre }}
      </h2>
    </header>
    

    {{ if or .Params.featured_image .Params.tickets }}
    <div class="w-100 flex">
      {{ with .Params.featured_image }}
      <!-- put the featured image in a link to open in a lightbox -->
      <a href="/media/posters/{{ . }}" data-lightbox="image-1" data-title="{{ . }}">
      <img src="/media/posters/{{ . }}" class="w5-l w4" />
      </a>
      {{ end }}
      <!-- If date and closing_date are both filed out -->
      {{ if and .Params.date .Params.closing_date }}
        <!-- If closing_date is in the future -->
        {{ $closingDate := time .Params.closing_date }}
        {{ $now := now.Format "2006-01-02" | time }}
        {{ if ge $closingDate $now }}
          {{ with .Params.tickets }}<a href="{{ . }}" target="_blank" class="dim h4 w-20 w4-ns pa0 ma3 mt0 tickets"></a>{{ end }}
        {{ end }}
      {{ end }}
    </div>
    {{ end}}

    <div class="nested-copy-line-height lh-copy f4-ns f5 mb5 {{ $.Param " text_color" | default "dark-gray" }}">
      <h3 class="f3 mt4 mb3 sectionline">Details</h3>
      {{ with .Params.year }}<div class="flex">
        <div class="w-25 b pa3-ns pa2 bb bw1 b--silver">Year</div>
        <div class="w-75 pa3-ns pa2 bb bw1 b--silver">{{ . }}</div>
      </div>{{ end }}
      {{ with .Params.theatre }}<div class="flex">
        <div class="w-25 b pa3-ns pa2 bb bw1 b--silver">Theatre</div>
        <div class="w-75 pa3-ns pa2 bb bw1 b--silver"><a href="/theatres/{{ . | urlize }}">{{ . }}</a></div>
      </div>{{ end }}
      {{ $currentPage := . }} <!-- Capture the current page context -->
      {{ with .Params.venue }}
        <div class="flex">
          <div class="w-25 b pa3-ns pa2 bb bw1 b--silver">Venue</div>
          <div class="w-75 pa3-ns pa2 bb bw1 b--silver">
            <a href="/venues/{{ . | urlize }}">{{ . }}</a>
            {{ $venuePage := $currentPage.Site.GetPage "page" (printf "/venues/%s" (. | urlize)) }} <!-- Use the captured page context -->
            {{ with $venuePage.Params.Address }} <!-- Access the 'Address' parameter -->
              <br />{{ . | replaceRE "\n" "<br />" | safeHTML }} <!-- Display the address with line breaks -->
              <ul class="map_links list mv1 pl0">
                <li><a target="_blank" href="https://www.google.com/maps/search/?api=1&query={{ . | urlize | replaceRE "%0A" "%20" }}">Google Maps</a></li>
                <li><a target="_blank" href="https://maps.apple.com/?q={{ . | urlize | replaceRE "%0A" "%20" }}">Apple Maps</a></li>
              </ul>
            {{ end }}
          </div>
        </div>
      {{ end }}      
      
      <!-- if date and closing_date  -->
      {{ if and .Params.date .Params.closing_date }}
        <div class="flex">
          <div class="w-25 b pa3-ns pa2 bb bw1 b--silver">Dates</div>
          {{ $startDate := time .Params.date }} <!-- Convert date to Hugo time object -->
          {{ $closingDate := time .Params.closing_date }}
          <div class="w-75 pa3-ns pa2 bb bw1 b--silver"> {{ $startDate.Format "Monday, January 2, 2006" }} â€” <br/>{{ $closingDate.Format "Monday, January 2, 2006" }}</div>
        </div>
      {{ end }}

      <!-- If showtimes exist -->
      {{ if .Params.showtimes }}
      <div class="flex flex-wrap">
        <div class="w-25-ns w-100 b pa3-ns pa2 bb bw1 b--silver">
          <a href="javascript:void(0);" onclick="toggleShowtimes()" id="showtimes-toggle">Showtimes...</a>
        </div>
        <div class="w-75-ns w-100 pa3-ns pa2 bb bw1 b--silver" id="showtimes-hidden-section"></div>
        <div class="w-75-ns w-100 pa3-ns pa2 bb bw1 b--silver dn" id="showtimes-section">
          {{ range .Params.showtimes }} <!-- Iterate over the showtimes -->
            {{ $showtime := time . }} <!-- Convert each showtime to a Hugo time object -->
            <div class="flex mb2 space-between">
              <div class="w-75 w-50-l bb bw.5 b--light-silver">{{ $showtime.Format "Monday, January 2, 2006" }}</div> <!-- Date column -->
              <div class="w-25 w-50-l bb bw.5 b--light-silver">{{ $showtime.Format "3:04 p.m." }}</div> <!-- Time column -->
            </div>
          {{ end }}
        </div>
      </div>
      <script>
        function toggleShowtimes() {
          var section = document.getElementById('showtimes-section');
          var hidden_section = document.getElementById('showtimes-hidden-section');
          if (section.style.display === 'none' || section.style.display === '') {
            section.style.display = 'block';
            hidden_section.style.display = 'none';
            document.getElementById('showtimes-toggle').innerHTML = 'Showtimes';
          } else {
            section.style.display = 'none';
            hidden_section.style.display = 'block';
            document.getElementById('showtimes-toggle').innerHTML = 'Showtimes...';
          }
        }
      </script>
      {{ end }}

      {{ with .Params.website }}<div class="flex">
        <div class="w-25 b pa3-ns pa2 bb bw1 b--silver">Website</div>
        <div class="w-75 pa3-ns pa2 bb bw1 b--silver"><a href="{{ . }}">Official Production Website</a></div>
      </div>{{ end }}
    </div>

    <!-- If cast exists -->
    {{ if .Params.cast }}
    <div class="nested-copy-line-height lh-copy f4 {{ $.Param " text_color" | default "dark-gray" }}">
          <h3 class="f3 mt4 mb3 sectionline">Cast</h3>
      {{ range .Params.cast }} <!-- Iterate over the cast array -->
        {{ range $character, $actor := . }} <!-- Iterate over key-value pairs -->
          <div class="flex bb bw1 b--silver f5 f4-ns">
            <div class="b pa3-ns pa2 w-50 w-30-l">{{ $character }}</div> <!-- Character name -->
              <div class="pa3-ns pa2 w-50 w-70-l">
              {{ if (eq (printf "%T" $actor) "[]interface {}") }} <!-- Check if actor is an array -->
                {{ range $idx, $a := $actor }} <!-- Iterate over the actors -->
                  <a href="/people/{{ $a | urlize }}">{{ $a }}</a>{{ if ne $idx (sub (len $actor) 1) }}, {{ end }} <!-- Separate by commas -->
                {{ end }}
              {{ else }}
                <a href="/people/{{ $actor | urlize }}">{{ $actor }}</a> <!-- Single actor name with URLized link -->
              {{ end }}
              </div>
          </div>
        {{ end }}
      {{ end }}
    </div>
    {{ end }}

    <!-- If crew exists -->
    {{ if .Params.crew }}
    <div class="nested-copy-line-height lh-copy f4 {{ $.Param " text_color" | default "dark-gray" }}">
          <h3 class="f3 mt4 mb3 sectionline">Crew</h3>
      {{ range .Params.crew }} <!-- Iterate over the crew array -->
        {{ range $role, $person := . }} <!-- Iterate over key-value pairs -->
        <div class="flex bb bw1 b--silver f5 f4-ns">
            <div class="w-25 b pa3-ns pa2 w-50 w-30-l">{{ $role }}</div> <!-- Role -->
              <div class="w-75 pa3-ns pa2 w-50 w-70-l">
              {{ if (eq (printf "%T" $person) "[]interface {}") }} <!-- Check if person is an array -->
                {{ range $idx, $p := $person }} <!-- Iterate over the persons -->
                  <a href="/people/{{ $p | urlize }}">{{ $p }}</a>{{ if ne $idx (sub (len $person) 1) }}, {{ end }} <!-- Separate by commas -->
                {{ end }}
              {{ else }}
                <a href="/people/{{ $person | urlize }}">{{ $person }}</a> <!-- Single person's name with URLized link -->
              {{ end }}
            </div>
          </div>
        {{ end }}
      {{ end }}
    </div>
    {{ end }}

    <!-- If understudies exists -->
    {{ if .Params.understudies }}
    <div class="nested-copy-line-height lh-copy f4 {{ $.Param " text_color" | default "dark-gray" }}">
          <h3 class="f3 mt4 mb3 sectionline">Understudies</h3>
      {{ range .Params.understudies }} <!-- Iterate over the understudies array -->
        {{ range $character, $actor := . }} <!-- Iterate over key-value pairs -->
        <div class="flex bb bw1 b--silver f5 f4-ns">
          <div class="w-25 b pa3-ns pa2 w-50 w-30-l">{{ $character }}</div> <!-- Character name -->
            <div class="w-75 pa3-ns pa2 w-50 w-70-l">
              <a href="/people/{{ $actor | urlize }}">{{ $actor }}</a> <!-- Actor name with URLized link -->
            </div>
          </div>
        {{ end }}
      {{ end }}
    </div>
    {{ end }}

    <!-- If orchestra exists -->
    {{ if .Params.orchestra }}
    <div class="nested-copy-line-height lh-copy f4 {{ $.Param " text_color" | default "dark-gray" }}">
          <h3 class="f3 mt4 mb3 sectionline">Orchestra</h3>
      {{ range .Params.orchestra }} <!-- Iterate over the orchestra array -->
        {{ range $instrument, $musician := . }} <!-- Iterate over key-value pairs -->
        <div class="flex bb bw1 b--silver f5 f4-ns">
          <div class="w-25 b pa3-ns pa2 w-50 w-30-l">{{ $instrument }}</div> <!-- Instrument name -->
            <div class="w-75 pa3-ns pa2 w-50 w-70-l">
              <a href="/people/{{ $musician | urlize }}">{{ $musician }}</a> <!-- Musician's name with URLized link -->
            </div>
          </div>
        {{ end }}
      {{ end }}
    </div>
    {{ end }}

    {{ with .Content }}
    <div class="nested-copy-line-height lh-copy f4 {{ $.Param " text_color" | default "dark-gray" }}">
      <h3 class="f3 mt4 mb3 sectionline">Synopsis</h3>
      {{ . }}
    </div>
    {{ end }}

  </article>
</div>
{{ end }}