{{ define "header" }}{{ partial "page-header.html" . }}{{ end }}
{{ define "main" }}
<script src='/fullcalendar/index.global.min.js'></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var whichView = function(width) {
      if (width < 768) {
        return 'listWeek';
      } else {
        return 'listWeek';
      }
    };

    var calendarEl = document.getElementById('calendar');
    var initialViewSetting = whichView(window.innerWidth);

    var calendar = new FullCalendar.Calendar(calendarEl, {
      height: 'auto',
      initialView: initialViewSetting,
      events: function(fetchInfo, successCallback, failureCallback) {
        // Fetch events from your JSON source here
        // For example, using Fetch API
        fetch('/calendar.json').then(response => response.json())
          .then(events => {
            // Filter events based on selected theatres
            var checkboxes = document.querySelectorAll('input[name="theatre"]:checked');
            var selectedTheatres = Array.from(checkboxes).map(c => c.value);
            var filteredEvents = events.filter(event => selectedTheatres.includes(event.theatre));
            successCallback(filteredEvents);
          })
          .catch(failureCallback);
      },
      slotMaxTime: '22:00:00',
      slotMinTime: '11:00:00',
      nowIndicator: true,
      expandRows: true,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'multiMonthYear,dayGridMonth,timeGridWeek,listWeek'
      }
    });

    var resize = function() {
      var fontSize = parseFloat(getComputedStyle(document.documentElement).fontSize);
      var emThreshold = 60 * fontSize;
      var newView = whichView(window.innerWidth);
    
      if (newView !== calendar.view.type) {
        calendar.changeView(newView);
      }

      if (window.innerWidth < emThreshold) {
        calendar.setOption('headerToolbar', {
          left: 'prev,next today',
          center: 'title',
          right: ''
        });
        calendar.setOption('navLinks', false);
      } else {
        calendar.setOption('headerToolbar', {
          left: 'prev,next today',
          center: 'title',
          right: 'multiMonthYear,dayGridMonth,timeGridWeek,listWeek'
        });
        calendar.setOption('navLinks', true);
      }
    };

    calendar.render();
    resize();
    window.addEventListener('resize', resize);

    var allTheatresCheckbox = document.getElementById('all_theatres');

    var toggleTheatreCheckboxes = function() {
      var checkboxes = document.querySelectorAll('input[name="theatre"]');
      checkboxes.forEach(function(checkbox) {
        if (checkbox.id !== 'all_theatres') {
          checkbox.checked = allTheatresCheckbox.checked;
        }
      });
      calendar.refetchEvents(); // Refetch events when theatres are toggled
    };

    allTheatresCheckbox.addEventListener('click', toggleTheatreCheckboxes);

    document.querySelectorAll('input[name="theatre"]').forEach(function(checkbox) {
      checkbox.addEventListener('click', function() {
        calendar.refetchEvents(); // Refetch events when any theatre is toggled
      });
    });
  });
</script>

<div class="flex-l mt0 mw9 center">
  <article class="center cf pv4 ph3 ph4-ns mw9 w-100">
    <header>
      <h1 class="f3 f1-l f1-m mt0">
        {{ .Title }}
      </h1>
    </header>
    <div class="nested-copy-line-height lh-copy f4 nested-links {{ $.Param "text_color" | default "mid-gray" }}">
      {{ .Content }}
      <div id='calendar'></div>
    </div>
    <h3 class="ph3 ph0-ns f2 mt5 mb2 sectionline">Filter by Theatre</h3>
    <div class="mw9 w-100 mt4 calendarcheckboxes flex flex-wrap">
      <div class="f4 pa2 w-50">
        <input class="w3" type="checkbox" id="all_theatres" name="theatre" value="all_theatres" checked="checked">
        <label class="ml2 b" for="all_theatres">All Theatres</label><br>
      </div>
      {{ range where .Site.Pages "Type" "theatres" }}
      {{ if eq .Params.active true }}
      <div class="f4 pa2 w-50">
        <input class="w3" type="checkbox" id="{{ .Title }}" name="theatre" value="{{ .Title }}" checked="checked">
        <label class="ml2" for="{{ .Title }}">{{ .Title }}</label><br>
      </div>
      {{ end }}
      {{ end }}
    </div>
  </article>
</div>

{{ end }}
