{{ $featuredImage := partial "func/GetFeaturedImage.html" . }}
{{ $featuredImageAlt := .Params.featured_image_alt }}
{{ $genres := .Params.genres }}

{{ if not $featuredImage }}
{{ range where .Site.Pages "Type" "shows" }}
{{ if eq .Title $.Title }}
{{ $featuredImage = .Params.featured_image }}
{{ $featuredImageAlt := .Params.featured_image_alt }}
{{ end }}
{{ end }}
{{ end }}

{{ $contentLength := len .Content }}
{{ $description := .Params.description }}
{{ if not $description }}
  {{ if gt $contentLength 275 }}
  {{ $description = printf "%s..." (substr .Content 0 275) }}
  {{ else }}
  {{ $description = substr .Content 0 $contentLength }}
  {{ end }}
{{ else }}
  {{ $description = $description | markdownify | safeHTML }}
{{ end }}

<article class="bb b--black-10 ">
  <div class="db pa3 no-underline dark-gray">    
      <h1 class="f3 fw7 avenir mt0 lh-title">
      <a href="{{.RelPermalink}}" class="color-inherit dim link">
        {{ .Title }}
        </a>
    </h1>
    <div class="flex flex-column flex-row-m flex-row-l">
    {{ if or .Params.theatre .Params.venue }}
      <h4 class="w-100 w-60-l mt0">
      {{ with .Params.theatre }}{{ . }}{{ end }}
      <br />{{ with .Params.venue }}{{ . }}{{ end }}
      </h4>
    {{ end }}
    {{ if and .Params.date .Params.closing_date }}
    {{ $startDate := time .Params.date }} <!-- Convert date to Hugo time object -->
    {{ $closingDate := time .Params.closing_date }}
    <div class="w-100 mb3 tr-ns w-50-l fw7"> {{ $startDate.Format "Monday, January 2, 2006" }} <span class="dn-ns dib"> — </span><br/>
     <span class="dn dib-ns"> — </span>
      {{ $closingDate.Format "Monday, January 2, 2006" }}</div>
  {{ end }}
    </div>

    <div class="flex flex-column flex-row-ns">
      {{ if or $featuredImage .Params.tickets }}
          {{/* Trimming the slash and adding absURL make sure the image works no matter where our site lives */}}
        <div class="{{ cond (eq $.Site.Language.LanguageDirection "rtl") "pl3-ns" "pr3-ns" }} mb4 mb0-ns w-100 w-40-ns">
          <a href="{{.RelPermalink}}" class="db grow">
            <img src="/media/posters/{{ $featuredImage }}" class="img" alt="image from {{ .Title }}">
          </a>
        </div>
      {{ end }}
      <div class="w-100{{ if $featuredImage }} {{ cond (eq $.Site.Language.LanguageDirection "rtl") "pr3-ns" "pl3-ns" }}{{ end }}">
      <!-- Genres and Tickets Section -->
      {{ if or $genres (and .Params.date .Params.closing_date) }}
      <div class="flex flex-column items-start justify-start">
        <!-- Genres -->
        {{ if $genres }}
        <div class="flex flex-wrap">
          {{ range $genres }}
          <a href="/genres/{{ . | urlize }}" class="link dim br4 ph3 pv2 mv2 mh1 h2 dib black bg-yellow">{{ . }}</a>
          {{ end }}
        </div>
        {{ end }}

        <!-- Tickets -->
        <!-- If date and closing_date are both filed out -->
        {{ if and .Params.date .Params.closing_date }}
        <!-- If closing_date is in the future -->
        {{ $closingDate := time .Params.closing_date }}
        {{ $now := now.Format "2006-01-02" | time }}
          {{ if ge $closingDate $now }}
          {{ with .Params.tickets }}<a href="{{ . }}" target="_blank" class="db pa0 ml1 mv2 mt0 tickets"></a>{{ end }}
          {{ end }}
        {{ end }}
        {{ end }}

        <!-- Description -->
        <div class="nested-copy-line-height lh-copy f4 mt0 {{ $.Param " text_color" | default "dark-gray" }}">
          {{ $description | safeHTML }}
        </div>
          <a href="{{.RelPermalink}}" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">{{ $.Param "read_more_copy" | default (i18n "readMore") }}</a>
      </div>
    </div>
  </div>
</article>
