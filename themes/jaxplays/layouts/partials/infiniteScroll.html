<nav class="post-navigation relative flex-l flex-wrap justify-between mw8 center ph3">
  {{ with .PrevInSection }}
  <h3>Previous {{ title .Section }}:<br /> <a id="prev-post-link" href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
  {{ end }}
  {{ with .NextInSection }}
  <h3>Next {{ title .Section }}:<br /> <a id="next-post-link" href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
  {{ end }}
</nav>

<script>
  window.nextPostUrl = document.getElementById('next-post-link')?.href || "";
  window.prevPostUrl = document.getElementById('prev-post-link')?.href || "";
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  let loading = false;
  let prevUrl = document.getElementById('prev-post-link')?.href || "";
  let adSlotIncrement = 1; // Keeps ad IDs unique

  window.addEventListener('scroll', function() {
    if (loading || !prevUrl) return;
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 600) {
      loading = true;
      fetch(prevUrl)
        .then(response => response.text())
        .then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const prevHeader = doc.querySelector('header');
          const prevPost = doc.querySelector('.main-content');
          const prevNav = doc.querySelector('.post-navigation');

          if (prevPost) {
            prevPost.id = '';
            if (prevHeader) {
              document.querySelector('.main-content').parentNode.appendChild(prevHeader);
            }
            document.querySelector('.main-content').parentNode.appendChild(prevPost);
            if (prevNav) {
              document.querySelector('.main-content').parentNode.appendChild(prevNav);
            }

            // ===== DYNAMIC BILLBOARD AD SLOT DEFINITION =====
            const adDivs = document.querySelectorAll('.gpt-ad[data-ad-unit="/23156489440/billboard-1"]:not([data-gpt-initialized])');
            adDivs.forEach(function(adDiv) {
              const newId = 'div-gpt-ad-billboard-' + (gptAdIndex++);
              adDiv.id = newId;
              adDiv.setAttribute('data-gpt-initialized', '1');
              const adUnit = adDiv.dataset.adUnit;
              const width = parseInt(adDiv.dataset.width, 10);
              const height = parseInt(adDiv.dataset.height, 10);
              if (window.googletag && googletag.apiReady) {
                googletag.cmd.push(function() {
                  googletag
                    .defineSlot(adUnit, [width, height], newId)
                    .addService(googletag.pubads());
                  googletag.display(newId);
                });
              }
            });

            // --- Update browser history to the new post ---
            const newUrl = doc.querySelector('link[rel="canonical"]')?.href
              || prevPost.querySelector('a[rel="bookmark"]')?.href
              || prevUrl;
            const newTitle = doc.querySelector('title')?.innerText || document.title;
            history.pushState({}, '', newUrl);
            document.title = newTitle;

            // Now, update prevUrl to the newly appended nav
            prevUrl = prevNav?.querySelector('#prev-post-link')?.href || "";
          } else {
            prevUrl = null;
          }
          loading = false;
        });
    }
  });
});
</script>
